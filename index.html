<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Civic AI Tech</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    
    <!-- Leaflet CSS for Free Map Integration -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    
    <link rel="stylesheet" href="./assets/styles.css" />
  </head>
  <body>
    <header class="hero">
      <nav class="top-nav" aria-label="Primary">
        <a class="brand" href="./index.html">ğŸ™ï¸ Civic AI Tech</a>
        <div class="nav-links">
          <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
            <span class="theme-icon">ğŸŒ™</span>
          </button>
          <a class="nav-link" href="./login.html" id="login-link">Login</a>
          <a class="nav-link" href="./dashboard.html" id="dashboard-link" style="display: none;">My Dashboard</a>
          <a class="nav-link" href="./admin.html" id="admin-link" style="display: none;">Admin</a>
          <button class="nav-link logout-btn" id="logout-link" style="display: none;">Logout</button>
        </div>
      </nav>
    </header>

    <!-- Hero Section with Civic Issue Background -->
    <section class="hero-banner">
      <div class="hero-content">
        <h1 class="hero-title">Make Your City Better ğŸŒŸ</h1>
        <p class="hero-subtitle">Report civic issues instantly with AI-powered assistance</p>
        <div class="hero-features">
          <div class="feature-badge">
            <span class="badge-icon">ğŸ“¸</span>
            <span>AI Analysis</span>
          </div>
          <div class="feature-badge">
            <span class="badge-icon">ğŸ—ºï¸</span>
            <span>Map Location</span>
          </div>
          <div class="feature-badge">
            <span class="badge-icon">âš¡</span>
            <span>Quick Filing</span>
          </div>
        </div>
      </div>
      <div class="hero-images">
        <div class="issue-showcase">
          <div class="issue-card" data-issue="pothole">
            <div class="issue-image-placeholder">
              <div class="issue-icon-large">ğŸ•³ï¸</div>
              <div class="issue-description">Damaged roads causing safety hazards</div>
            </div>
            <div class="issue-label">Potholes & Road Damage</div>
          </div>
          <div class="issue-card" data-issue="streetlight">
            <div class="issue-image-placeholder">
              <div class="issue-icon-large">ğŸ’¡</div>
              <div class="issue-description">Non-functional or broken streetlights</div>
            </div>
            <div class="issue-label">Broken Streetlights</div>
          </div>
          <div class="issue-card" data-issue="garbage">
            <div class="issue-image-placeholder">
              <div class="issue-icon-large">ğŸ—‘ï¸</div>
              <div class="issue-description">Waste accumulation & sanitation issues</div>
            </div>
            <div class="issue-label">Garbage & Waste</div>
          </div>
          <div class="issue-card" data-issue="tree">
            <div class="issue-image-placeholder">
              <div class="issue-icon-large">ğŸŒ³</div>
              <div class="issue-description">Storm-damaged or hazardous trees</div>
            </div>
            <div class="issue-label">Fallen Trees</div>
          </div>
          <div class="issue-card" data-issue="drainage">
            <div class="issue-image-placeholder">
              <div class="issue-icon-large">ğŸ’§</div>
              <div class="issue-description">Blocked drains causing flooding</div>
            </div>
            <div class="issue-label">Drainage Problems</div>
          </div>
          <div class="issue-card" data-issue="animal">
            <div class="issue-image-placeholder">
              <div class="issue-icon-large">ğŸ„</div>
              <div class="issue-description">Dead animals requiring removal</div>
            </div>
            <div class="issue-label">Dead Animal Removal</div>
          </div>
        </div>
      </div>
    </section>

    <main>
      <section class="upload-card">
        <h2>File Your Complaint</h2>
        <p>Help us improve your neighborhood - it only takes a minute!</p>
        
        <form class="upload-form" aria-label="File civic complaint">
          
          <!-- Main Category Selection -->
          <label class="form-field" for="main-category">
            <span class="label">Main Category *</span>
            <select id="main-category" required>
              <option value="">Loading categories...</option>
            </select>
            <small class="field-hint">Select the main type of civic issue</small>
          </label>

          <!-- Sub Category (Dynamic) -->
          <label class="form-field" for="sub-category" id="sub-category-field" hidden>
            <span class="label">Sub Category *</span>
            <select id="sub-category" required>
              <option value="">Select main category first</option>
            </select>
            <small class="field-hint">Select specific issue type</small>
          </label>

          <!-- Image Upload (Optional for some categories) -->
          <div class="form-section" id="image-upload-section">
            <h3 id="image-section-title">ğŸ“· Upload Image (Optional for some categories)</h3>
            <label class="file-area" for="issue-file">
              <svg width="32" height="32" viewBox="0 0 24 24" aria-hidden="true">
                <path
                  d="M12 16v-8m0 0l-3 3m3-3l3 3M5 20h14a2 2 0 002-2v-4a2 2 0 00-2-2h-1M5 20a2 2 0 01-2-2v-4a2 2 0 012-2h1"
                  fill="none"
                  stroke="currentColor"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="1.5"
                />
              </svg>
              <span>
                <strong>Select an image</strong>
                <em>Supports camera or gallery uploads</em>
              </span>
              <!-- Removed capture attribute so users can choose Camera or Gallery on mobile -->
              <input type="file" id="issue-file" accept="image/*" />
              <!-- Dedicated camera input for users who want to capture directly -->
              <input type="file" id="issue-camera" accept="image/*" capture="environment" hidden />
            </label>
            <div class="upload-actions">
              <button type="button" id="choose-gallery" class="analysis-button" style="border-style: dashed;">ğŸ“ Choose from Gallery</button>
              <button type="button" id="use-camera" class="analysis-button">ğŸ“· Use Camera</button>
            </div>
            <p id="file-status" class="file-status">No image selected.</p>
            <figure id="file-preview" class="file-preview" hidden>
              <img src="" alt="Selected civic issue preview" />
            </figure>
            
            <div class="analysis-row">
              <button type="button" id="analysis-btn" class="analysis-button" disabled>
                ğŸ¤– Analyse image with AI
              </button>
              <p id="analysis-status" class="analysis-status" role="status">
                Upload an image to enable AI analysis
              </p>
            </div>
          </div>

          <!-- Description -->
          <label class="form-field" for="issue-description">
            <span class="label">Describe the issue *</span>
            <textarea
              id="issue-description"
              rows="4"
              placeholder="Share details: what is happening, severity, any risks, etc."
              required
            ></textarea>
            <small class="field-hint">AI can help generate description if image is uploaded</small>
          </label>

          <!-- Location -->
          <div class="location-actions">
            <button type="button" id="location-btn" class="location-button">
              ğŸ“ Use My Current Location
            </button>
            <button type="button" id="map-location-btn" class="location-button secondary">
              ğŸ—ºï¸ Select Location on Map
            </button>
            <div class="location-status">
              <p id="location-message">Location not selected.</p>
              <p id="location-coords" aria-live="polite"></p>
            </div>
          </div>

          <!-- Map Modal -->
          <div id="map-modal" class="map-modal" style="display: none;">
            <div class="map-modal-content">
              <div class="map-modal-header">
                <h3>ğŸ“ Select Issue Location</h3>
                <button type="button" id="close-map" class="close-map-btn">&times;</button>
              </div>
              <div class="map-search">
                <input 
                  type="text" 
                  id="location-search" 
                  placeholder="Search for a location (e.g., 'Mumbai Central Station')"
                  class="location-search-input"
                />
                <button type="button" id="search-location-btn" class="search-btn">ğŸ” Search</button>
                <button type="button" id="my-location-btn" class="search-btn" style="background: linear-gradient(135deg, #10b981, #059669);">
                  ğŸ“ Your Location
                </button>
              </div>
              <div id="map" class="location-map"></div>
              <div class="map-instructions">
                <p>ğŸ“Œ Click on the map to select the exact location of the civic issue</p>
                <p id="selected-address">No location selected</p>
              </div>
              <button type="button" id="confirm-location-btn" class="confirm-location-btn" disabled>
                âœ… Confirm This Location
              </button>
            </div>
          </div>

          <!-- Submit Button -->
          <button type="button" id="complaint-btn" class="complaint-button" disabled>
            File Complaint
          </button>
          <p id="complaint-hint" class="button-hint">
            Complete all required fields and grant location access to file complaint.
          </p>
          <p id="complaint-confirmation" class="confirmation" hidden></p>
        </form>
      </section>

      <section class="about">
        <h2>Why Civic AI Tech?</h2>
        <p>
          We partner with public institutions to design, deploy, and monitor artificial
          intelligence that serves every resident fairly.
        </p>
      </section>

      <!-- Our Impact Section -->
      <section class="impact-section">
        <h2 class="section-title">ğŸ¯ Our Impact</h2>
        <p class="section-subtitle">See how we're making cities better, one complaint at a time</p>
        
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon">ğŸ“Š</div>
            <div class="stat-number">1,000+</div>
            <div class="stat-label">Complaints Filed</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">âœ…</div>
            <div class="stat-number">750+</div>
            <div class="stat-label">Issues Resolved</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">âš¡</div>
            <div class="stat-number">48hrs</div>
            <div class="stat-label">Avg Response Time</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">ğŸ˜Š</div>
            <div class="stat-number">95%</div>
            <div class="stat-label">Satisfaction Rate</div>
          </div>
        </div>

        <div class="success-stories">
          <h3 class="stories-title">âœ¨ Recent Success Stories</h3>
          <div class="stories-grid">
            <div class="story-card">
              <div class="story-badge">Resolved</div>
              <div class="story-icon">ğŸ•³ï¸</div>
              <h4>Pothole on MG Road</h4>
              <p>Reported: Jan 15 â€¢ Fixed: Jan 18</p>
              <div class="story-footer">
                <span class="resolution-time">3 days</span>
              </div>
            </div>
            <div class="story-card">
              <div class="story-badge">Resolved</div>
              <div class="story-icon">ğŸ’¡</div>
              <h4>Broken Streetlight</h4>
              <p>Reported: Jan 10 â€¢ Fixed: Jan 12</p>
              <div class="story-footer">
                <span class="resolution-time">2 days</span>
              </div>
            </div>
            <div class="story-card">
              <div class="story-badge">Resolved</div>
              <div class="story-icon">ğŸ—‘ï¸</div>
              <h4>Garbage Pile Removal</h4>
              <p>Reported: Jan 8 â€¢ Fixed: Jan 9</p>
              <div class="story-footer">
                <span class="resolution-time">1 day</span>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer>
      <small>Â© <span id="year"></span> Civic AI Tech Â· Making Cities Better Together ğŸ’š</small>
    </footer>

    <!-- Leaflet JS for Free Map Integration -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>

    <!-- Theme Toggle Script (loads first) -->
    <script src="./assets/theme.js"></script>

    <!-- Auth check happens immediately when this script loads -->
    <script type="module" src="./assets/main.js?v=2.0"></script>
    <script>
      // Handle main category selection
      mainCategorySelect?.addEventListener('change', async (e) => {
        const categoryId = e.target.value;
        selectedMainCategory = categoryId;
        
        console.log('ğŸ”„ Main category changed to:', categoryId);
        
        if (!categoryId) {
          subCategoryField.hidden = true;
          subCategorySelect.innerHTML = '<option value="">Select main category first</option>';
          updateImageRequirement(false);
          updateComplaintButton();
          return;
        }
        
        // Load sub-categories
        try {
          console.log('ğŸ”„ Loading sub-categories for:', categoryId);
          const response = await fetch(`${API_BASE_URL}/api/categories/${categoryId}/subcategories`);
          if (!response.ok) throw new Error('Failed to load sub-categories');
          
          const data = await response.json();
          console.log('âœ… Loaded sub-categories:', data.subCategories.length, 'items');
          
          populateSubCategories(data.subCategories);
          
          // Update image requirement based on category
          const selectedOption = e.target.options[e.target.selectedIndex];
          const requiresImage = selectedOption.dataset.requiresImage === 'true';
          updateImageRequirement(requiresImage);
          
        } catch (error) {
          console.error('Error loading sub-categories:', error);
          subCategorySelect.innerHTML = '<option value="">Error loading sub-categories</option>';
        }
        
        updateComplaintButton();
      });
    </script>
  </body>
</html>
